<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PMT æ•™é¤Šæ•™ç·´ Chatbot</title>
    <!-- ä½¿ç”¨ Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* éš±è—æ»¾å‹•æ¢ä½†ä¿æŒåŠŸèƒ½ */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        /* è¨Šæ¯å‹•ç•« */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .message-anim {
            animation: fadeIn 0.3s ease-out forwards;
        }
        body {
            -webkit-tap-highlight-color: transparent;
        }
    </style>
</head>
<body class="bg-gray-100 h-[100dvh] flex flex-col items-center justify-center font-sans text-gray-800">

    <!-- App Container -->
    <div class="w-full max-w-md h-full bg-gray-50 flex flex-col shadow-2xl relative overflow-hidden sm:rounded-xl sm:h-[90vh] sm:border sm:border-gray-200">
        
        <!-- Header -->
        <header class="bg-teal-600 text-white p-4 flex justify-between items-center shadow-md z-10 shrink-0">
            <div class="flex items-center gap-3">
                <div class="bg-white/20 p-2 rounded-full">
                    <!-- Bot Icon -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 8V4H8"/><rect width="16" height="12" x="4" y="8" rx="2"/><path d="M2 14h2"/><path d="M20 14h2"/><path d="M15 13v2"/><path d="M9 13v2"/></svg>
                </div>
                <div>
                    <h1 class="font-bold text-lg leading-tight">PMT æ•™é¤Šæ•™ç·´</h1>
                    <p class="text-xs text-teal-100 opacity-90">å…’ç«¥é’å°‘å¹´ç²¾ç¥ç§‘ è¡›æ•™å°ˆç”¨</p>
                </div>
            </div>
            <button onclick="resetChat()" class="p-2 hover:bg-teal-700 rounded-full transition-colors active:scale-95" title="é‡æ–°é–‹å§‹">
                <!-- Refresh Icon -->
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></svg>
            </button>
        </header>

        <!-- Chat Area -->
        <div id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-4 scroll-smooth">
            <!-- Messages will be injected here via JS -->
        </div>

        <!-- Input Area (Hidden by default) -->
        <div id="input-area" class="hidden p-4 bg-white border-t border-gray-200 shrink-0">
            <form onsubmit="handleInputSubmit(event)" class="flex gap-2">
                <input type="text" id="user-input" autocomplete="off" placeholder="è«‹è¼¸å…¥..." class="flex-1 px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-teal-500 bg-gray-50 text-base">
                <button type="submit" class="bg-teal-600 text-white p-3 rounded-xl hover:bg-teal-700 active:bg-teal-800 transition-colors shadow-sm">
                    <!-- Send Icon -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></svg>
                </button>
            </form>
        </div>

    </div>

    <!-- Script -->
    <script>
        // --- Data & Scenarios ---
        const SCENARIOS = {
            start: {
                text: "å®¶é•·æ‚¨å¥½ï¼Œæˆ‘æ˜¯æ‚¨çš„æ•™é¤Šæ•™ç·´ã€‚ç¾åœ¨å­©å­çš„æƒ…æ³å¦‚ä½•ï¼Ÿè«‹é¸æ“‡ä¸€å€‹ç·´ç¿’æ¨¡å¼ï¼š",
                type: 'options',
                options: [
                    { label: "ğŸ˜¤ å­©å­ç¾åœ¨æ­£åœ¨æš´æ€’/è·³è…³", nextStep: "tantrum_1" },
                    { label: "ğŸ“¢ ç·´ç¿’ã€Œæœ‰æ•ˆæŒ‡ä»¤ã€(å«ä¸å‹•)", nextStep: "eid_intro" },
                    { label: "ğŸ¤ å»ºç«‹é—œä¿‚ (è¦ªå­é»ƒé‡‘æ™‚é–“)", nextStep: "jasper_1" },
                    { label: "ğŸ® æ¨¡æ“¬æƒ…å¢ƒæ¸¬é©— (Role Play)", nextStep: "quiz_1" },
                ]
            },

            // --- Scenario 1: Tantrum ---
            tantrum_1: {
                text: "æ”¶åˆ°ã€‚ç•¶å­©å­æƒ…ç·’ã€Œæ ¸å½ˆçˆ†ç‚¸ã€æ™‚ï¼Œå¤§è…¦å‰é¡è‘‰å·²é—œæ©Ÿã€‚ç¾åœ¨è«‹æ·±å‘¼å¸ï¼Œä¸è¦èªªæ•™ã€‚\n\nè«‹é¸æ“‡æ‚¨ç¬¬ä¸€å¥è©²èªªçš„è©±ï¼š",
                type: 'options',
                options: [
                    { label: "ä½ ç‚ºä»€éº¼è¦ç”Ÿæ°£ï¼Ÿèªªå‡ºä¾†ï¼", nextStep: "tantrum_wrong_why" },
                    { label: "ä¸å¯ä»¥é€™æ¨£ï¼æˆ‘æ•¸åˆ°ä¸‰ï¼", nextStep: "tantrum_wrong_threat" },
                    { label: "æˆ‘çœ‹è¦‹ä½ éå¸¸ç”Ÿæ°£/æŒ«æŠ˜...", nextStep: "tantrum_correct_label" },
                ]
            },
            tantrum_wrong_why: {
                text: "âŒ ä¿®æ­£ï¼šç¾åœ¨å•ã€Œç‚ºä»€éº¼ã€å­©å­ç­”ä¸å‡ºä¾†ï¼Œåªæœƒè¦ºå¾—è¢«è³ªå•ã€‚\n\næ ¹æ“šæƒ…ç·’èª¿ç¯€åŸå‰‡ï¼Œæˆ‘å€‘è¦å…ˆã€Œæ¨™è¨˜æƒ…ç·’ã€ã€‚è©¦è©¦çœ‹é€™å¥ï¼š",
                type: 'options',
                options: [{ label: "é‡è©¦ï¼šæˆ‘çœ‹è¦‹ä½ éå¸¸ç”Ÿæ°£...", nextStep: "tantrum_correct_label" }]
            },
            tantrum_wrong_threat: {
                text: "âŒ ä¿®æ­£ï¼šå¨è„…æˆ–æ•¸æ•¸åœ¨å­©å­æƒ…ç·’é«˜é»æ™‚ï¼Œåªæœƒç«ä¸Šæ¾†æ²¹ã€‚\n\næˆ‘å€‘éœ€è¦å…ˆé™æº«ã€‚è©¦è©¦çœ‹é€™å¥ï¼š",
                type: 'options',
                options: [{ label: "é‡è©¦ï¼šæˆ‘çœ‹è¦‹ä½ éå¸¸ç”Ÿæ°£...", nextStep: "tantrum_correct_label" }]
            },
            tantrum_correct_label: {
                text: "âœ… æ­£ç¢º (æ¨™è¨˜æƒ…ç·’)ã€‚é€™èƒ½å®‰æ’«æä»æ ¸ã€‚\n\nç¬¬äºŒæ­¥æ˜¯ã€Œè¨­é™ã€ã€‚è«‹é¸æ“‡ä¸‹ä¸€å¥ï¼š",
                type: 'options',
                options: [
                    { label: "ä½†æ˜¯ä¸å¯ä»¥ä¸Ÿæ±è¥¿/æ‰“äººã€‚", nextStep: "tantrum_limit_set" },
                    { label: "ä½ å†é€™æ¨£ä¸‹æ¬¡å°±ä¸å¸¶ä½ ä¾†äº†ã€‚", nextStep: "tantrum_wrong_threat_2" },
                ]
            },
            tantrum_wrong_threat_2: {
                text: "âŒ é¿å…æ¨¡ç³Šçš„å¨è„…ã€‚è«‹çµ¦äºˆå…·é«”ã€ç•¶ä¸‹çš„è¡Œç‚ºé™åˆ¶ã€‚",
                type: 'options',
                options: [{ label: "ä½†æ˜¯ä¸å¯ä»¥ä¸Ÿæ±è¥¿/æ‰“äººã€‚", nextStep: "tantrum_limit_set" }]
            },
            tantrum_limit_set: {
                text: "âœ… å¾ˆå¥½ã€‚ç¬¬ä¸‰æ­¥æ˜¯ã€Œç­‰å¾…èˆ‡é™ªä¼´ã€ã€‚\n\nç¾åœ¨è«‹å°å­©å­èªªï¼šã€Œæˆ‘åœ¨é€™è£¡é™ªä½ ï¼Œç­‰ä½ å†·éœæˆ‘å€‘å†èªªã€‚ã€ç„¶å¾Œè«‹ä¿æŒå®‰éœï¼Œåšæ‚¨è‡ªå·±çš„äº‹ï¼Œç›´åˆ°å“­è²è®Šå°ã€‚",
                type: 'options',
                options: [{ label: "å›åˆ°ä¸»é¸å–®", nextStep: "start" }]
            },

            // --- Scenario 2: EID ---
            eid_intro: {
                text: "å­©å­è½ä¸è¦‹æ‚¨çš„è©±ï¼Œé€šå¸¸æ˜¯å› ç‚ºæŒ‡ä»¤å¤ªé•·æˆ–åƒå•å¥ã€‚\n\nç¾åœ¨è«‹è¼¸å…¥ä¸€å€‹æ‚¨å¸Œæœ›å­©å­å»åšçš„å–®ä¸€å‹•ä½œï¼ˆä¾‹å¦‚ï¼šå»æ´—æ¾¡ã€æ”¶ç©å…·ï¼‰ï¼š",
                type: 'input',
                inputPlaceholder: "ä¾‹å¦‚ï¼šæŠŠæ¨‚é«˜æ”¶å›ç®±å­è£¡",
                nextStep: "eid_practice"
            },
            eid_practice: {
                text: (input) => `æ”¶åˆ°ã€‚æ‚¨æƒ³è®“å­©å­ã€Œ${input}ã€ã€‚\n\nè«‹é¸æ“‡æ‚¨å¹³å¸¸ç¿’æ…£çš„èªªæ³•ï¼š`,
                type: 'options',
                options: [
                    { label: "èƒ½ä¸èƒ½å»æŠŠæ±è¥¿æ”¶ä¸€æ”¶ï¼Ÿ", nextStep: "eid_wrong_question" },
                    { label: "å¿«é»å¼„å¥½ï¼Œä¸è¦å†æ‹–äº†ï¼", nextStep: "eid_wrong_vague" },
                    { label: "çœ‹è‘—æˆ‘ã€‚(åœé “) å»åš...", nextStep: "eid_correct" },
                ]
            },
            eid_wrong_question: {
                text: "âŒ ä¿®æ­£ï¼šé€™æ˜¯ã€Œå•å¥ã€ï¼Œå­©å­å¤§è…¦æœƒç›´è¦ºå›ç­”ã€Œä¸è¦ã€ã€‚\n\nPMTåŸå‰‡ï¼šè«‹ç”¨ã€Œç¥ˆä½¿å¥ã€ã€‚è«‹è©¦è©¦çœ‹ï¼š",
                type: 'options',
                options: [{ label: "çœ‹è‘—æˆ‘ã€‚æŠŠç©å…·æ”¶å¥½ã€‚", nextStep: "eid_correct" }]
            },
            eid_wrong_vague: {
                text: "âŒ ä¿®æ­£ï¼šé€™å¸¶æœ‰æƒ…ç·’ä¸”æŒ‡ä»¤ä¸æ˜ç¢ºã€‚\n\nPMTåŸå‰‡ï¼šæŒ‡ä»¤è¦å…·é«”ã€ä¸­æ€§ã€‚è«‹è©¦è©¦çœ‹ï¼š",
                type: 'options',
                options: [{ label: "çœ‹è‘—æˆ‘ã€‚æŠŠç©å…·æ”¶å¥½ã€‚", nextStep: "eid_correct" }]
            },
            eid_correct: {
                text: "âœ… å®Œç¾ã€‚é€™å°±æ˜¯ EID (æœ‰æ•ˆæŒ‡ä»¤å‚³é)ã€‚\n\nSOPï¼š\n1. èµ°åˆ°é¢å‰ (è·é›¢ä¸€æ‰‹è‡‚)\n2. çœ¼ç¥æ¥è§¸\n3. ç°¡çŸ­æŒ‡ä»¤ (ä¸è¦åƒæ¼”è¬›)\n4. ç­‰å¾… 5 ç§’",
                type: 'options',
                options: [{ label: "å†ç·´ç¿’ä¸€æ¬¡", nextStep: "eid_intro" }, { label: "å›åˆ°ä¸»é¸å–®", nextStep: "start" }]
            },

            // --- Scenario 3: JASPER ---
            jasper_1: {
                text: "æ”¹å–„é—œä¿‚æ˜¯æ¸›å°‘æš´æ€’çš„åŸºç¤ã€‚æˆ‘å€‘ç·´ç¿’ã€Œæ—ç™½æ³• (Sportscasting)ã€ã€‚\n\næƒ³åƒå­©å­æ­£åœ¨ç©ç©æœ¨ï¼Œä½†æ²’çœ‹ä½ ã€‚æ‚¨è©²èªªä»€éº¼ï¼Ÿ",
                type: 'options',
                options: [
                    { label: "ä½ è¦ä¸è¦ç–Šé«˜ä¸€é»ï¼Ÿåƒé€™æ¨£ï¼Ÿ", nextStep: "jasper_wrong_command" },
                    { label: "å“‡ï¼Œä½ æ‹¿äº†ä¸€å€‹ç´…è‰²çš„ç©æœ¨ï¼Œç–Šåœ¨è—è‰²ä¸Šé¢ã€‚", nextStep: "jasper_correct" },
                    { label: "ä½ æ€éº¼éƒ½äº‚ç–Šï¼Œè¦é€™æ¨£æ’æ‰å°ã€‚", nextStep: "jasper_wrong_critique" },
                ]
            },
            jasper_wrong_command: {
                text: "âŒ é€™æ˜¯ã€ŒæŒ‡ä»¤ã€æˆ–ã€Œå¹²æ¶‰ã€ã€‚\n\nåœ¨ç‰¹åˆ¥æ™‚é–“ (Special Time) è£¡ï¼Œè«‹æ”¾ä¸‹ä¸»å°æ¬Šã€‚åªè¦æè¿°å°±å¥½ã€‚",
                type: 'options',
                options: [{ label: "é‡è©¦ï¼šæè¿°ä»–çš„å‹•ä½œ...", nextStep: "jasper_correct" }]
            },
            jasper_wrong_critique: {
                text: "âŒ é€™æ˜¯ã€Œæ‰¹è©•ã€ã€‚æœƒç ´å£èˆˆè‡´ã€‚\n\nè«‹å–®ç´”åƒé«”è‚²ä¸»æ’­ä¸€æ¨£æè¿°ä½ çœ‹è¦‹çš„ã€‚",
                type: 'options',
                options: [{ label: "é‡è©¦ï¼šæè¿°ä»–çš„å‹•ä½œ...", nextStep: "jasper_correct" }]
            },
            jasper_correct: {
                text: "âœ… å¤ªæ£’äº†ï¼é€™å°±æ˜¯ã€Œå…±åŒæ³¨æ„åŠ›ã€ã€‚\n\nç•¶å­©å­è¦ºå¾—ä½ æ‡‚ä»–åœ¨ç©ä»€éº¼ï¼Œä¸”ä¸æŒ‡æ®ä»–ï¼Œå®‰å…¨æ„Ÿå°±æœƒå»ºç«‹ã€‚æ¯å¤©é€™æ¨£åš 5 åˆ†é˜å³å¯ã€‚",
                type: 'options',
                options: [{ label: "å›åˆ°ä¸»é¸å–®", nextStep: "start" }]
            },

            // --- Scenario 4: Quiz ---
            quiz_1: {
                text: "ã€æ¨¡æ“¬è€ƒã€‘å­©å­æ­£åœ¨çœ‹é›»è¦–ï¼Œè©²åƒé£¯äº†ã€‚æ‚¨èµ°éå»ï¼Œä»–èªªï¼šã€Œä¸è¦ï¼æˆ‘é‚„è¦çœ‹ï¼ã€\n\næ‚¨çš„ä¸‹ä¸€æ­¥ï¼Ÿ",
                type: 'options',
                options: [
                    { label: "æŠŠé›»è¦–ç›´æ¥é—œæ‰ï¼Œæ‹‰ä»–èµ°ã€‚", nextStep: "quiz_wrong_force" },
                    { label: "èªªï¼šã€Œæˆ‘çœ‹è¦‹ä½ å¾ˆæƒ³çœ‹é›»è¦–ï¼Œä½†ç¾åœ¨æ˜¯åƒé£¯æ™‚é–“ã€‚ã€", nextStep: "quiz_correct_validate" },
                    { label: "èªªï¼šã€Œä½ æ¯æ¬¡éƒ½é€™æ¨£ï¼å†ä¸ä¾†æˆ‘å°±ä¸Ÿæ‰é›»è¦–ï¼ã€", nextStep: "quiz_wrong_nag" },
                ]
            },
            quiz_wrong_force: {
                text: "âŒ å¼·åˆ¶é—œæ©Ÿé€šå¸¸æœƒå¼•ç™¼ã€Œæ ¸å½ˆåæ‡‰ã€ã€‚æˆ‘å€‘éœ€è¦å…ˆé å‘Šæˆ–åŒç†ã€‚",
                type: 'options',
                options: [{ label: "è©¦è©¦çœ‹ï¼šåŒç† + è¨­é™", nextStep: "quiz_correct_validate" }]
            },
            quiz_wrong_nag: {
                text: "âŒ ç¿»èˆŠå¸³èˆ‡å¨è„…æœƒè®“ç„¦é»è½‰ç§»åˆ°æƒ…ç·’å°æŠ—ï¼Œè€Œéåƒé£¯é€™ä»¶äº‹ã€‚",
                type: 'options',
                options: [{ label: "è©¦è©¦çœ‹ï¼šåŒç† + è¨­é™", nextStep: "quiz_correct_validate" }]
            },
            quiz_correct_validate: {
                text: "âœ… æ­£ç¢ºã€‚å…ˆåŒç† ( æˆ‘çœ‹åˆ°...) å†è¨­é™ (ä½†æ˜¯...)ã€‚\n\nå¦‚æœä»–é‚„æ˜¯å°–å«ï¼Ÿ",
                type: 'options',
                options: [
                    { label: "é–‹å§‹è§£é‡‹ç‚ºä»€éº¼åƒé£¯å¾ˆé‡è¦...", nextStep: "quiz_wrong_explain" },
                    { label: "ç ´å”±ç‰‡æ³•ï¼šé‡è¤‡ç°¡çŸ­æŒ‡ä»¤ã€Œç¾åœ¨å»æ´—æ‰‹åƒé£¯ã€ï¼Œç„¶å¾Œç­‰å¾…ã€‚", nextStep: "quiz_correct_done" },
                ]
            },
            quiz_wrong_explain: {
                text: "âŒ å­©å­æƒ…ç·’æ¿€å‹•æ™‚è½ä¸é€²è§£é‡‹ã€‚è«‹ä¿æŒç°¡çŸ­ã€‚",
                type: 'options',
                options: [{ label: "ä½¿ç”¨ç ´å”±ç‰‡æ³• (Broken Record)", nextStep: "quiz_correct_done" }]
            },
            quiz_correct_done: {
                text: "âœ… æ­å–œé€šéæ¸¬è©¦ï¼æ‚¨å·²ç¶“æŒæ¡äº† PMT çš„æ ¸å¿ƒæŠ€å·§ï¼šæº«å’Œä½†å …å®šã€‚",
                type: 'options',
                options: [{ label: "å›åˆ°ä¸»é¸å–®", nextStep: "start" }]
            }
        };

        // --- Logic ---
        const chatContainer = document.getElementById('chat-container');
        const inputArea = document.getElementById('input-area');
        const inputField = document.getElementById('user-input');
        
        let currentStep = 'start';
        let tempInput = ''; // Store user text input for later use

        function init() {
            addBotMessage('start');
        }

        function scrollToBottom() {
            setTimeout(() => {
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }, 50);
        }

        function createMessageElement(sender, text, isCorrect) {
            const wrapper = document.createElement('div');
            wrapper.className = `flex w-full message-anim ${sender === 'user' ? 'justify-end' : 'justify-start'}`;

            const bubble = document.createElement('div');
            // Style logic matching the React version
            const baseClass = "max-w-[85%] rounded-2xl p-4 shadow-sm text-base leading-relaxed break-words whitespace-pre-wrap";
            const botClass = "bg-white text-gray-800 border border-gray-100 rounded-tl-none";
            const userClass = "bg-teal-500 text-white rounded-tr-none";
            
            bubble.className = `${baseClass} ${sender === 'user' ? userClass : botClass}`;
            
            // Bot Label
            if (sender === 'bot') {
                const labelHTML = `
                    <div class="flex items-center gap-2 mb-2 border-b border-gray-100 pb-1">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-teal-600"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
                        <span class="text-xs font-bold text-teal-600">æŒ‡å¼•</span>
                    </div>
                `;
                bubble.innerHTML = labelHTML + text;
            } else {
                bubble.textContent = text;
                // Feedback Icon for user
                if (isCorrect !== undefined) {
                    const iconHTML = isCorrect 
                        ? `<div class="mt-2 flex justify-end"><svg class="w-4 h-4 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg></div>`
                        : `<div class="mt-2 flex justify-end"><svg class="w-4 h-4 text-red-200" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg></div>`;
                    bubble.innerHTML += iconHTML;
                }
            }

            wrapper.appendChild(bubble);
            return wrapper;
        }

        function createOptionsElement(options) {
            const container = document.createElement('div');
            container.className = "grid gap-2 mt-4 message-anim pl-4 pr-12"; // Indent slightly to align with bot msg

            options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = "text-left w-full px-4 py-3 bg-white text-teal-800 rounded-xl hover:bg-teal-50 transition-colors border border-teal-200 text-sm font-medium flex items-center gap-2 shadow-sm active:bg-teal-100 group";
                btn.innerHTML = `
                    <svg class="w-4 h-4 text-teal-400 group-hover:text-teal-600 fill-current shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"/></svg>
                    <span>${opt.label}</span>
                `;
                btn.onclick = () => handleOptionClick(opt);
                container.appendChild(btn);
            });
            return container;
        }

        function addBotMessage(stepKey, dynamicInput) {
            const step = SCENARIOS[stepKey];
            if (!step) return;

            // Remove old options if any
            const oldOptions = document.querySelectorAll('.grid.gap-2');
            oldOptions.forEach(el => el.remove());

            // Determine text
            let msgText = step.text;
            if (typeof msgText === 'function') {
                msgText = msgText(dynamicInput || tempInput);
            }

            // Add Bot Message Bubble
            const msgEl = createMessageElement('bot', msgText);
            chatContainer.appendChild(msgEl);
            scrollToBottom();

            // Handle UI based on type
            if (step.type === 'options' && step.options) {
                // Delay showing options slightly for effect
                setTimeout(() => {
                    const optsEl = createOptionsElement(step.options);
                    chatContainer.appendChild(optsEl);
                    scrollToBottom();
                }, 400);
                inputArea.classList.add('hidden');
            } else if (step.type === 'input') {
                inputArea.classList.remove('hidden');
                inputField.placeholder = step.inputPlaceholder || "è«‹è¼¸å…¥...";
                inputField.value = '';
                inputField.focus();
            } else {
                inputArea.classList.add('hidden');
            }
        }

        function handleOptionClick(option) {
            // Determine if correct based on nextStep name (simple heuristic)
            const isCorrect = !option.nextStep.includes('wrong');

            // Add User Message Bubble
            const userMsgEl = createMessageElement('user', option.label, isCorrect);
            chatContainer.appendChild(userMsgEl);
            
            // Remove options buttons visually (already done by addBotMessage logic clearing old options, but we can hide current ones immediately)
            const currentOptions = chatContainer.querySelector('.grid.gap-2:last-child');
            if (currentOptions) currentOptions.style.display = 'none';

            scrollToBottom();

            // Proceed to next step
            currentStep = option.nextStep;
            setTimeout(() => {
                addBotMessage(currentStep, tempInput);
            }, 600);
        }

        function handleInputSubmit(e) {
            e.preventDefault();
            const val = inputField.value.trim();
            if (!val) return;

            // Save input
            tempInput = val;

            // Add User Message
            const userMsgEl = createMessageElement('user', val);
            chatContainer.appendChild(userMsgEl);
            scrollToBottom();

            // Hide input
            inputArea.classList.add('hidden');

            // Determine next step
            const currentStepData = SCENARIOS[currentStep];
            const nextStep = currentStepData.nextStep || 'start';
            currentStep = nextStep;

            setTimeout(() => {
                addBotMessage(nextStep, val);
            }, 600);
        }

        function resetChat() {
            chatContainer.innerHTML = '';
            tempInput = '';
            currentStep = 'start';
            init();
        }

        // Start
        init();

    </script>
</body>
</html>
